<!DOCTYPE html>
<html>

<head>
	<title></title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="style.css">

</head>

<body>
	<div class="cont">
		<div class="map-sel">
			<div class="inner">
				<h1 class="heading">Map Selection</h1>
				<div class="divider"></div>
				<p class="helper phase-el phase-1">Click a map to make your selection!</p>
				<p class="helper phase-el phase-2 hidden invis">Waiting for selections...</p>
				<div class="counter phase-el phase-2 hidden invis">
					<span class="voted">
						<div class="counter-number">1</div>
						<div class="counter-number">2</div>
						<div class="counter-number">3</div>
						<div class="counter-number">4</div>
						<div class="counter-number">5</div>
						<div class="counter-number">6</div>
						<div class="counter-number">7</div>
						<div class="counter-number">8</div>
						<div class="counter-number">9</div>
						<div class="counter-number">10</div>
					</span>
					<span class="total">/ 10</span>
				</div>
				<p class="timer">00:<span class="tick">15</span></p>
				<button class="reset-btn invis hidden">Rerun</button>
				<div class="votes-block phase-2 invis hidden">
					<span class="vote-el-0">0</span>
					<span class="vote-el-1">0</span>
					<span class="vote-el-2">0</span>
				</div>
				<div class="maps phase-el phase-1">
					<div class="map map-1" data-map="0">
						<div class="map-bg"></div>
						<div class="map-info">
							<p class="map-name"></p>
							<p class="map-type"></p>
						</div>
					</div>
					<div class="map map-2" data-map="1">
						<div class="map-bg"></div>
						<div class="map-info">
							<p class="map-name"></p>
							<p class="map-type"></p>
						</div>
					</div>
					<div class="map map-3" data-map="2">
						<div class="map-bg"></div>
						<div class="map-info">
							<p class="map-name"></p>
							<p class="map-type"></p>
						</div>
					</div>
				</div>
				<svg class="circle-cont phase-el phase-2 hidden invis" viewBox="0 0 450 450">
					<defs>
						<pattern id="niflhel" patternUnits="userSpaceOnUse" width="400" height="400" x="25" y="25">
							<image xlink:href="https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-nifl.png"
								width="400" height="400" />
						</pattern>
						<pattern id="foefire" patternUnits="userSpaceOnUse" width="400" height="400" x="25" y="25">
							<image xlink:href="https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-foe.png"
								width="400" height="400" />
						</pattern>
						<pattern id="kyhlo" patternUnits="userSpaceOnUse" width="400" height="400" x="25" y="25">
							<image xlink:href="https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-kyh.png"
								width="400" height="400" />
						</pattern>
						<pattern id="courtyard" patternUnits="userSpaceOnUse" width="400" height="400" x="25" y="25">
							<image xlink:href="https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-pvp.png"
								width="400" height="400" />
						</pattern>
						<pattern id="temple" patternUnits="userSpaceOnUse" width="400" height="400" x="25" y="25">
							<image xlink:href="https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-sil.png"
								width="400" height="400" />
						</pattern>
						<pattern id="skyhammer" patternUnits="userSpaceOnUse" width="400" height="400" x="25" y="25">
							<image xlink:href="https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-sky.png"
								width="400" height="400" />
						</pattern>
						<pattern id="spirit" patternUnits="userSpaceOnUse" width="400" height="400" x="25" y="25">
							<image xlink:href="https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-spi.png"
								width="400" height="400" />
						</pattern>
						<filter id="dropshadow">
							<feGaussianBlur in="SourceAlpha" stdDeviation="4" />
							<feOffset dx="5" dy="7" result="offsetblur" />
							<feMerge>
								<feMergeNode />
								<feMergeNode in="SourceGraphic" />
							</feMerge>
						</filter>
						<radialGradient id="outerGrad">
							<stop offset="90%" stop-color="rgb(27, 29, 28)" />
							<stop offset="99%" stop-color="rgb(47, 49, 48)" />
						</radialGradient>
						<linearGradient id="linGrad" gradientTransform="rotate(45)">
							<stop offset="0%" stop-color="rgb(46, 99, 118)" />
							<stop offset="99%" stop-color="rgb(78, 11, 88)" />
						</linearGradient>
						<linearGradient id="arrowGrad">
							<stop offset="0%" stop-color="rgb(5, 5, 7)" />
							<stop offset="50%" stop-color="rgb(245, 252, 245)" />
							<stop offset="100%" stop-color="rgb(5, 5, 7)" />
						</linearGradient>
					</defs>
					<path class="circuit" stroke="rgb(5, 5, 7)" stroke-width="8" fill="none"
						d="M225,23 a202,202 0 0,1 0,404 a202,202 0 0,1 0,-404" />
					<path class="big-circle" filter="url(#dropshadow)" stroke="url(#linGrad)" stroke-width="24"
						fill="none" d="M225,12 a212,212 0 0,1 0,426 a212,212 0 0,1 0,-426" />
					<path class="pick-arrow phase-el" filter="url(#dropshadow)" stroke="url(#arrowGrad)"
						stroke-width="3" fill="none"
						d="M125,51.8 a202,202 0 0,1 82.568,-26.039 L225,70 L242.432,25.761 a202,202 0 0,1 82.568,26.039" />
					<text class="chosen-mapName invis" fill="#fff" font-family="Open Sans" font-size="28" x="225"
						y="225" style="text-anchor: middle;">
					</text>
				</svg>
				<div class="divider bottom"></div>
				<div class="check-out">Check out my other <a href="https://codepen.io/suez/public/"
						target="_blank">pens</a></div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		window.onload = function () {

			var paths = {},
				animTime = 500,
				mapsInfo = {
					"kyhlo": {
						"bg": "https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-big-kyh.jpg",
						"fullName": "Battle of Kyhlo"
					},
					"niflhel": {
						"bg": "https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-big-nif.jpg",
						"fullName": "Forest of Corona"
					},
					"foefire": {
						"bg": "https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-big-foe.jpg",
						"fullName": "Legacy of the Foefire"
					},
					"skyhammer": {
						"bg": "https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-big-sky.jpg",
						"fullName": "Skyhammer"
					},
					"spirit": {
						"bg": "https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-big-spi.jpg",
						"fullName": "Spirit Watch"
					},
					"temple": {
						"bg": "https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-big-sil.jpg",
						"fullName": "Temple of the Silent Storm"
					},
					"courtyard": {
						"bg": "https://s3-us-west-2.amazonaws.com/s.cdpn.io/142996/gw2-big-pvp.png",
						"fullName": "Courtyard",
						"type": "Team Deathmatch"
					}
				},
				picks = [],
				votes = [0, 0, 0],
				angle1 = 0,
				angle2 = 0,
				angle3 = 0;

			function addClass(el, cl) {
				try {
					el.classList.add(cl);
				} catch (e) {
					el.setAttribute("class", el.getAttribute("class") + " " + cl);
				}
			}

			function removeClass(el, cl) {
				try {
					el.classList.remove(cl);
				} catch (e) {
					// ie have problems with svg className and classList
					var regEx = new RegExp("\\b" + cl + "\\b", "gi");
					el.setAttribute("class", el.getAttribute("class").replace(regEx, ""));
				}
			}

			function hasClass(el, className) {
				var regEx = new RegExp(className, "gi");
				return regEx.test(el.getAttribute("class"));
			}

			function getCoords(centerX, centerY, radius, angleInDegrees) {
				var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;

				return {
					x: centerX + (radius * Math.cos(angleInRadians)),
					y: centerY + (radius * Math.sin(angleInRadians))
				};
			}

			function createCirclePart(x, y, r, startA, angle, img, cl, el) {
				var path = document.createElementNS('http://www.w3.org/2000/svg', "path"),
					lineC = getCoords(x, y, r, startA),
					finalC = getCoords(x, y, r, angle + startA),
					finalX = finalC.x - lineC.x,
					finalY = finalC.y - lineC.y,
					arcSweep = Math.abs(angle) <= 180 ? "0" : "1",
					arc2 = angle >= 0 ? "1" : "0",
					d = ["M" + x + "," + y,
					"L" + lineC.x + "," + lineC.y,
					"a" + r + "," + r,
					"0 " + arcSweep + "," + arc2,
					finalX + "," + finalY + "z"].join(" ");

				path.setAttribute("fill", "url(#" + img + ")");
				path.setAttribute("d", d);
				var stroke = "#000";
				if (Math.abs(angle) >= 358 || Math.abs(angle) < 3) {
					stroke = "transparent";
				}
				path.setAttribute("stroke", stroke);
				path.setAttribute("stroke-width", 4);
				path.setAttribute("class", cl);

				if (!el) {
					var circuit = document.querySelector(".circuit");
					document.querySelector(".circle-cont").insertBefore(path, circuit);
					paths[cl] = {
						x: x,
						y: y,
						r: r,
						startA: startA,
						lastAngle: angle,
						img: img
					}
				} else {
					document.querySelector("." + el).setAttribute("d", d);
					document.querySelector("." + el).setAttribute("stroke", stroke);
				}
			}

			function changePart(cl, endAngle, time, newStart) {
				var p = paths[cl],
					angleDiff = endAngle - p.lastAngle,
					//mult = Math.abs(angleDiff) >= 130 ? 2 : 1,
					steps = time / (1000 / 60),
					anglePiece = angleDiff / steps,
					start = newStart !== undefined ? newStart : p.startA,
					requestAnim,
					intCounter = 0;

				if (newStart !== undefined) {
					var startDiff = newStart - p.startA,
						startPiece = startDiff / steps;
				}

				function animate() {
					paths[cl].animating = true;
					intCounter++;
					requestAnim = requestAnimationFrame(animate);
					var nextAngle = p.lastAngle + anglePiece * intCounter,
						nextStart = newStart !== undefined ? p.startA + startPiece * intCounter : start;

					createCirclePart(p.x, p.y, p.r, nextStart, nextAngle, p.img, cl, cl);

					if (intCounter >= steps || paths[cl].intercept) {
						paths[cl].lastAngle = nextAngle;
						paths[cl].startA = nextStart !== undefined ? nextStart : start;
						window.cancelAnimationFrame(requestAnim);
						requestAnim = undefined;
						paths[cl].intercept = false;
						paths[cl].animating = false;
					}
				}
				if (paths[cl].animating) {
					paths[cl].intercept = true;
					setTimeout(function () {
						// ASYNC HELL
						changePart(cl, endAngle, time, newStart);
					}, 0);
				} else {
					animate();
				}
			}

			function defineWinner(angle) {
				var result = angle % 360,
					fastAnim = 250,
					mapName = document.querySelector(".chosen-mapName"),
					resetBtn = document.querySelector(".reset-btn"),
					timer = document.querySelector(".timer"),
					winner;
				if (result <= angle1) {
					changePart("pick-1", 359.99, fastAnim);
					changePart("pick-2", 0, fastAnim, 359.99);
					changePart("pick-3", 0, fastAnim);
					winner = 0;
				} else if (result > angle1 && result <= angle1 + angle2) {
					changePart("pick-1", 0, fastAnim);
					changePart("pick-2", 359.99, fastAnim, 0);
					changePart("pick-3", 0, fastAnim);
					winner = 1;
				} else {
					changePart("pick-1", 0, fastAnim);
					changePart("pick-2", 0, fastAnim, 0);
					changePart("pick-3", -359.99, fastAnim);
					winner = 2;
				}
				addClass(document.querySelector(".pick-arrow"), "invis");
				mapName.textContent = mapsInfo[picks[winner]].fullName;
				removeClass(mapName, "invis");
				setTimeout(function () {
					removeClass(resetBtn, "hidden");
					addClass(timer, "invis");
					var trigger = resetBtn.offsetHeight;
					removeClass(resetBtn, "invis");
					addClass(timer, "hidden");
				}, 300);
			}

			function startPickArrow() {
				var arrow = document.querySelector(".pick-arrow"),
					endTime = Math.floor(Math.random() * 1500 + 1000),
					ticks = endTime / (1000 / 60),
					rafCounter = 0,
					raf;

				function rotateArrow() {
					rafCounter++;
					raf = requestAnimationFrame(rotateArrow);
					arrow.setAttribute("transform", "rotate(" + rafCounter * 15 + ", 225, 225)");
					if (rafCounter >= ticks) {
						window.cancelAnimationFrame(raf);
						raf = undefined;
						setTimeout(function () {
							defineWinner(rafCounter * 15);
						}, 700);
					}
				}

				rotateArrow();
			}

			function randomMaps() {
				var mapsArray = ["kyhlo", "niflhel", "foefire", "skyhammer", "spirit", "temple", "courtyard"];
				picks.length = 0;
				var paths = [].slice.call(document.querySelectorAll("path"));
				paths.map(function (el) {
					if (hasClass(el, "pick-1") || hasClass(el, "pick-2") || hasClass(el, "pick-3")) {
						el.parentNode.removeChild(el);
					}
				});

				for (var i = 0; i < 3; i++) {
					picks.push(mapsArray.splice(Math.floor(Math.random() * mapsArray.length), 1)[0]);
				}

				createCirclePart(225, 225, 200, 0, 0, picks[0], "pick-1");
				createCirclePart(225, 225, 200, 0, 0, picks[1], "pick-2");
				createCirclePart(225, 225, 200, 360, 0, picks[2], "pick-3");

				var mapBlocks = [].slice.call(document.querySelectorAll(".map"));
				mapBlocks.map(function (el, index) {
					el.querySelector(".map-bg").style.backgroundImage = "url(" + mapsInfo[picks[index]].bg + ")";
					el.querySelector(".map-name").innerHTML = mapsInfo[picks[index]].fullName;
					if (mapsInfo[picks[index]].type) {
						el.querySelector(".map-type").innerHTML = mapsInfo[picks[index]].type;
					} else {
						el.querySelector(".map-type").innerHTML = "Conquest";

					}
				});

				var intCounter = 1,
					interval;

				interval = setInterval(function () {
					if (intCounter > 15) {
						window.clearInterval(interval);
						var time = 500;
						if (!userPicked) {
							showHidePhases();
							time = 1000;
						}
						setTimeout(function () {
							startPickArrow();
						}, time);
						return;
					}
					var resultNumber = 15 - intCounter;
					if (resultNumber < 10) resultNumber = "0" + resultNumber;
					document.querySelector(".tick").innerHTML = resultNumber;
					intCounter++;
				}, 1000);

				setTimeout(function () {
					if (!userPicked) {
						startRandom();
						randomUsed = true;
					}
				}, 3500);
			}
			randomMaps();

			function submitVote(vote) {
				votes[vote]++;
				var numberOfVotes = votes.reduce(function (p, n) { return p + n }, 0),
					counter = [].slice.call(document.querySelectorAll(".counter-number"));

				votes.map(function (el, index) {
					document.querySelector(".vote-el-" + index).innerHTML = el;
				});

				angle1 = votes[0] / numberOfVotes * 360;
				angle2 = votes[1] / numberOfVotes * 360;
				angle3 = votes[2] / numberOfVotes * 360;


				if (angle1 === 360) angle1 = 359.99;
				if (angle2 === 360) angle2 = 359.99;
				if (angle3 === 360) angle3 = 359.99;

				changePart("pick-1", angle1, animTime);
				changePart("pick-2", angle2, animTime, angle1);
				changePart("pick-3", 0 - angle3, animTime);

				counter.map(function (el) {
					el.style.transform = "translateY(" + (0 - 100 * (numberOfVotes - 1)) + "%)";
				});
			}

			function timeoutVote(avgTime) {
				setTimeout(function () {
					submitVote(Math.floor(Math.random() * 3));
				}, Math.floor(Math.random() * 1000) + avgTime);
			}

			var randomUsed = false,
				userPicked = false;

			function startRandom() {
				if (randomUsed) return;
				timeoutVote(1000);
				timeoutVote(2500);
				timeoutVote(3800);
				timeoutVote(5300);
				timeoutVote(6200);
				timeoutVote(7300);
				timeoutVote(8700);
				timeoutVote(9600);
				timeoutVote(10500);
			}

			var $maps = [].slice.call(document.querySelectorAll(".map"));

			function showHidePhases() {
				var phase1 = [].slice.call(document.querySelectorAll(".phase-1")),
					phase2 = [].slice.call(document.querySelectorAll(".phase-2"));

				phase1.map(function (p1el) {
					addClass(p1el, "invis");
				});

				setTimeout(function () {
					phase1.map(function (p1el) {
						addClass(p1el, "hidden");
					});
					phase2.map(function (p2el) {
						removeClass(p2el, "hidden");
						var triggerLayout = p2el.offsetHeight;
						removeClass(p2el, "invis");
					});
				}, 300);
			}

			$maps.map(function (el) {
				el.addEventListener("click", function (e) {
					var vote = el.getAttribute("data-map");

					showHidePhases();
					userPicked = true;

					setTimeout(function () {
						submitVote(vote);
						startRandom();
					}, 600);

				}, false);
			});

			function reset() {
				var phaseElems = [].slice.call(document.querySelectorAll(".phase-el")),
					phase2 = [].slice.call(document.querySelectorAll(".phase-2"));

				phaseElems.map(function (el) {
					removeClass(el, "hidden");
					removeClass(el, "invis");
				});
				phase2.map(function (el) {
					addClass(el, "hidden");
					addClass(el, "invis");
				});
				addClass(document.querySelector(".chosen-mapName"), "invis");
				addClass(document.querySelector(".reset-btn"), "invis");
				addClass(document.querySelector(".reset-btn"), "hidden");
				removeClass(document.querySelector(".timer"), "invis");
				removeClass(document.querySelector(".timer"), "hidden");

				votes = [0, 0, 0];
				randomUsed = false;
				userPicked = false;

				document.querySelector(".vote-el-0").innerHTML = 0;
				document.querySelector(".vote-el-1").innerHTML = 0;
				document.querySelector(".vote-el-2").innerHTML = 0;

				var counter = [].slice.call(document.querySelectorAll(".counter-number"));
				document.querySelector(".pick-arrow").setAttribute("transform", "rotate(0, 225, 225)");

				counter.map(function (el) {
					el.style.transform = "translateY(0%)";
				});

				randomMaps();
			}

			document.querySelector(".reset-btn").addEventListener("click", function () {
				reset();
			}, false);

		};

	</script>
</body>

</html>